<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ep001 + PiP Switcher (Top Panel)</title>
<style>
  :root{ --pad:14px; --pip-w:360px; --pip-h:240px; --panel-h:60px; }
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  #main{position:fixed; inset:0; width:100%; height:100%; border:0; background:#0b1220}

  /* PiP 預設：避開上方面板 */
  #pip{
    position:fixed; right:var(--pad); top:calc(var(--pad) + var(--panel-h));
    width:var(--pip-w); height:var(--pip-h);
    background:#0b1220; border:1px solid #283449; border-radius:12px; overflow:hidden;
    box-shadow: 0 6px 30px rgba(0,0,0,.45); transition:all 0.3s ease;
  }
  #pip iframe{ width:100%; height:100%; border:0; display:block; border-radius:inherit; }
  .size-handle{ position:absolute; right:6px; bottom:6px; width:16px; height:16px; cursor:nwse-resize;
                border-right:2px solid #64748b; border-bottom:2px solid #64748b; opacity:.9; }

  /* 全螢幕時，同樣避開上方面板高度 */
  #pip.fullscreen {
    top: var(--panel-h) !important; left:0 !important; right:0 !important; bottom:0 !important;
    width:100% !important; height:auto !important; border-radius:0 !important;
  }

  /* 面板：改為上方橫條 */
  .panel {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    height: var(--panel-h);
    background: rgba(12,18,32,.85);
    border-bottom: 1px solid #263248;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    font-size: 14px;
    backdrop-filter: blur(6px) saturate(1.2);
    box-shadow: 0 4px 20px rgba(0,0,0,.35);
    overflow-x: auto;
    z-index: 50;
  }
  .row{ display:flex; align-items:center; gap:8px; }
  .btn{ padding:6px 10px; border-radius:8px; border:1px solid #374151; background:#111827; color:#e5e7eb; cursor:pointer; }
  .btn:hover{ background:#0f172a; }
  select, input[type="range"]{ background:#0b1220; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:4px 6px; }
  .small{ font-size:12px; opacity:.8 }

  /* 小螢幕：維持原檔邏輯 - 面板與 PiP 隱藏 */
  @media (max-width: 640px) {
    .panel, #pip { display: none !important; }
  }
</style>
</head>
<body>
  <iframe id="main" src="前右輪1019.html" allow="xr; autoplay; fullscreen"></iframe>

  <div id="pip">
    <iframe id="pipFrame" src="CP/32358.html" allow="xr; autoplay; fullscreen"></iframe>
    <div class="size-handle" id="sizeHandle" title="拖曳以改變大小"></div>
  </div>

  <div class="panel" id="panel">
    <div class="row">
      <label for="srcSel">PiP來源：</label>
      <select id="srcSel">
        <option value="CP/32358.html" selected>輪胎</option>
        <option value="CP/31040A.html">框</option>
      </select>
      <button class="btn" id="reload">重載</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="togglePip" checked> 顯示PiP</label>
      <label><input type="checkbox" id="clickThrough"> 滑鼠穿透</label>
    </div>
    <div class="row">
      <span class="small">透明度</span>
      <input type="range" id="opacity" min="30" max="100" value="100">
      <span class="small" id="opv">100%</span>
    </div>
    <div class="row">
      <button class="btn" data-size="240x160">小</button>
      <button class="btn" data-size="360x240">中</button>
      <button class="btn" data-size="480x320">大</button>
      <button class="btn" data-size="640x426">XL</button>
      <button class="btn" id="toggleFS">⛶ 全螢幕</button>
    </div>
    <div class="row">
      <button class="btn" id="pinTL">↖</button>
      <button class="btn" id="pinTR">↗</button>
      <button class="btn" id="pinBL">↙</button>
      <button class="btn" id="pinBR">↘</button>
    </div>
    <div class="row small">快捷鍵：1/2/3/4 切換、H 顯示、T 穿透、F 全螢幕</div>
  </div>

<script>
  const pip = document.getElementById('pip');
  const pipFrame = document.getElementById('pipFrame');
  const srcSel = document.getElementById('srcSel');
  const reloadBtn = document.getElementById('reload');

  const setSrc = (val)=>{ pipFrame.src = val; srcSel.value = val; };
  srcSel.addEventListener('change', ()=> setSrc(srcSel.value));
  reloadBtn.addEventListener('click', ()=> pipFrame.src = pipFrame.src);

  document.getElementById('togglePip').addEventListener('change', e=>{
    pip.style.display = e.target.checked ? 'block' : 'none';
  });

  const opacity = document.getElementById('opacity');
  const opv = document.getElementById('opv');
  const setOpacity = v => { pip.style.opacity = (v/100).toString(); opv.textContent = v + '%'; };
  opacity.addEventListener('input', e=> setOpacity(e.target.value));
  setOpacity(opacity.value);

  const setSize = (w,h)=>{ pip.style.width = w+'px'; pip.style.height = h+'px'; };
  document.querySelectorAll('.btn[data-size]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const [w,h] = btn.dataset.size.split('x').map(Number);
      setSize(w,h);
    });
  });

  // 重新定位：上方面板高度 60px，加上 14px 安全距
  const SAFE_TOP = 74;  // 60 + 14
  const resetPin = ()=>{ pip.style.left=''; pip.style.top=''; pip.style.right=''; pip.style.bottom=''; };
  document.getElementById('pinTL').addEventListener('click', ()=>{ resetPin(); pip.style.left='14px'; pip.style.top= SAFE_TOP + 'px'; });
  document.getElementById('pinTR').addEventListener('click', ()=>{ resetPin(); pip.style.right='14px'; pip.style.top= SAFE_TOP + 'px'; });
  document.getElementById('pinBL').addEventListener('click', ()=>{ resetPin(); pip.style.left='14px'; pip.style.bottom='14px'; });
  document.getElementById('pinBR').addEventListener('click', ()=>{ resetPin(); pip.style.right='14px'; pip.style.bottom='14px'; });

  const clickThrough = document.getElementById('clickThrough');
  clickThrough.addEventListener('change', e=>{
    pip.style.pointerEvents = e.target.checked ? 'none' : 'auto';
  });

  (function dragPip(){
    let dragging=false, sx=0, sy=0, ox=0, oy=0;
    pip.addEventListener('pointerdown', (e)=>{
      if (e.target.id === 'sizeHandle') return;
      dragging=true; sx=e.clientX; sy=e.clientY; ox=pip.offsetLeft; oy=pip.offsetTop;
      pip.setPointerCapture(e.pointerId);
    });
    pip.addEventListener('pointermove', (e)=>{
      if (!dragging) return;
      pip.style.left = (ox + e.clientX - sx)+'px';
      pip.style.top  = (oy + e.clientY - sy)+'px';
      pip.style.right=''; pip.style.bottom='';
    });
    pip.addEventListener('pointerup', ()=> dragging=false);
  })();

  (function resizePip(){
    const handle = document.getElementById('sizeHandle');
    let resizing=false, sx=0, sy=0, sw=0, sh=0;
    handle.addEventListener('pointerdown', (e)=>{
      resizing=true; sx=e.clientX; sy=e.clientY; sw=pip.offsetWidth; sh=pip.offsetHeight;
      handle.setPointerCapture(e.pointerId);
    });
    handle.addEventListener('pointermove', (e)=>{
      if (!resizing) return;
      const dw = e.clientX - sx, dh = e.clientY - sy;
      pip.style.width  = Math.max(160, sw + dw) + 'px';
      pip.style.height = Math.max(120, sh + dh) + 'px';
    });
    handle.addEventListener('pointerup', ()=> resizing=false);
  })();

  const toggleFS = document.getElementById('toggleFS');
  toggleFS.addEventListener('click', ()=>{
    pip.classList.toggle('fullscreen');
    toggleFS.textContent = pip.classList.contains('fullscreen') ? '⛶ 還原' : '⛶ 全螢幕';
  });

  addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k==='1') setSrc('0913_Box.html');
    if (k==='2') setSrc('0913ConeL.html');
    if (k==='3') setSrc('0913ConeR.html');
    if (k==='4') setSrc('Suzanne_0913.html');
    if (k==='h') document.getElementById('togglePip').click();
    if (k==='t') document.getElementById('clickThrough').click();
    if (k==='f') toggleFS.click();
  });

  // 外部可呼叫動作
  function CubeAction(){ setSrc('0913_Box.html'); }
  function ConeLAction(){ setSrc('0913ConeL.html'); }
  function ConeRAction(){ setSrc('0913ConeR.html'); }
  function SuzanneAction(){ setSrc('Suzanne_0913.html'); }
  window.CubeAction = CubeAction;
  window.ConeLAction = ConeLAction;
  window.SuzanneAction = SuzanneAction;
</script>

<script>
// === ChatGPT Inject v5: receive Ep014 postMessage and trigger PiP actions ===
(function(){
  function onMsg(event){
    const data = event && event.data;
    if (!data || data.type !== 'Ep014Select') return;
    const v = data.value;
    console.log('[1008PS_06 v5] 收到 Ep014Select:', v);
    try {
      if (v === 'Cube' && typeof window.CubeAction === 'function') return void window.CubeAction();
      if (v === 'ConeL' && typeof window.ConeLAction === 'function') return void window.ConeLAction();
      if (v === 'ConeR' && typeof window.ConeRAction === 'function') return void window.ConeRAction();
      if (v === 'Suzanne' && typeof window.SuzanneAction === 'function') return void window.SuzanneAction();
      console.log('[1008PS_06 v5] 未對應的 value:', v);
    } catch(e){ console.warn(e); }
  }
  window.addEventListener('message', onMsg, false);
  console.log('[1008PS_06 v5] 已啟用 postMessage 接收器');
})();
</script>
</body>
</html>
