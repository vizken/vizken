<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Forklift + PiP Switcher (Direct Open)</title>
<style>
  :root{ --pad:14px; --pip-w:360px; --pip-h:240px; }
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  #main{position:fixed; inset:0; width:100%; height:100%; border:0; background:#0b1220}

  #pip{ position:fixed; right:var(--pad); bottom:calc(var(--pad) + 60px);
        width:var(--pip-w); height:var(--pip-h);
        background:#0b1220; border:1px solid #283449; border-radius:12px; overflow:hidden;
        box-shadow: 0 6px 30px rgba(0,0,0,.45); transition:all 0.3s ease; }
  #pip iframe{ width:100%; height:100%; border:0; display:block; border-radius:inherit; }
  .size-handle{ position:absolute; right:6px; bottom:6px; width:16px; height:16px; cursor:nwse-resize;
                border-right:2px solid #64748b; border-bottom:2px solid #64748b; opacity:.9; }

  #pip.fullscreen {
    top:0 !important; left:0 !important; right:0 !important; bottom:60px !important;
    width:100% !important; height:auto !important; border-radius:0 !important;
  }

  .panel {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 60px;
    background: rgba(12,18,32,.85);
    border-top: 1px solid #263248;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    font-size: 14px;
    backdrop-filter: blur(6px) saturate(1.2);
    box-shadow: 0 -4px 20px rgba(0,0,0,.35);
    overflow-x: auto;
  }
  .row{ display:flex; align-items:center; gap:8px; }
  .btn{ padding:6px 10px; border-radius:8px; border:1px solid #374151; background:#111827; color:#e5e7eb; cursor:pointer; }
  .btn:hover{ background:#0f172a; }
  select, input[type="range"]{ background:#0b1220; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:4px 6px; }
  .small{ font-size:12px; opacity:.8 }
  
  /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
  #status-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 8px 16px;
    background: rgba(34, 197, 94, 0.9);
    color: white;
    border-radius: 8px;
    font-size: 12px;
    z-index: 1000;
    display: none;
  }
  
  #status-indicator.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
  <!-- ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="status-indicator"></div>

  <iframe id="main" src="Forklift.html" allow="xr; autoplay; fullscreen"></iframe>

  <div id="pip">
    <iframe id="pipFrame" src="æ¤…å­.html" allow="xr; autoplay; fullscreen"></iframe>
    <div class="size-handle" id="sizeHandle" title="æ‹–æ›³ä»¥æ”¹è®Šå¤§å°"></div>
  </div>

  <div class="panel" id="panel">
    <div class="row">
      <label for="srcSel">PiPä¾†æºï¼š</label>
      <select id="srcSel">
        <option value="Pip_ForkA.html" selected>å‰å‰</option>
        <option value="è»Šæ¶.html">è»Šæ¶</option>
        <option value="æ§åˆ¶å°.html">æ§åˆ¶å°</option>
        <option value="æ¤…å­.html">æ¤…å­</option>
		<option value="è…³è¸.html">è…³è¸</option>
		<option value="èƒŒè»Šæ®¼.html">èƒŒè»Šæ®¼</option>
		<option value="Pip_å‰å³è¼ª.html">å‰å³è¼ª</option>
		<option value="Pip_å‰å·¦è¼ª.html">å‰å·¦è¼ª</option>
		<option value="å¾Œå³è¼ªA.html">å¾Œå³è¼ª</option>
		<option value="å¾Œå·¦è¼ªA.html">å¾Œå·¦è¼ª</option>
      </select>
      <button class="btn" id="reload">é‡è¼‰</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="togglePip" checked> é¡¯ç¤ºPiP</label>
      <label><input type="checkbox" id="clickThrough"> æ»‘é¼ ç©¿é€</label>
      <label><input type="checkbox" id="autoSwitch" checked> ğŸ”— è‡ªå‹•åˆ‡æ›</label>
    </div>
    <div class="row">
      <span class="small">é€æ˜åº¦</span>
      <input type="range" id="opacity" min="30" max="100" value="100">
      <span class="small" id="opv">100%</span>
    </div>
    <div class="row">
      <button class="btn" data-size="240x160">å°</button>
      <button class="btn" data-size="360x240">ä¸­</button>
      <button class="btn" data-size="480x320">å¤§</button>
      <button class="btn" data-size="640x426">XL</button>
      <button class="btn" id="toggleFS">â›¶ å…¨è¢å¹•</button>
    </div>
    <div class="row">
      <button class="btn" id="pinTL">â†–</button>
      <button class="btn" id="pinTR">â†—</button>
      <button class="btn" id="pinBL">â†™</button>
      <button class="btn" id="pinBR">â†˜</button>
    </div>
    <div class="row small">å¿«æ·éµï¼šH é¡¯ç¤ºã€T ç©¿é€ã€F å…¨è¢å¹•</div>
  </div>

<script>
  const pip = document.getElementById('pip');
  const pipFrame = document.getElementById('pipFrame');
  const srcSel = document.getElementById('srcSel');
  const reloadBtn = document.getElementById('reload');
  const statusIndicator = document.getElementById('status-indicator');
  const autoSwitchCheckbox = document.getElementById('autoSwitch');

  // ç‰©ä»¶åç¨±åˆ° HTML æ–‡ä»¶çš„æ˜ å°„
  const objectToFileMap = {
    'å‰å‰': 'Pip_ForkA.html',
    'è»Šæ¶': 'è»Šæ¶.html',
    'æ§åˆ¶å°': 'æ§åˆ¶å°.html',
    'æ¤…å­': 'æ¤…å­.html',
    'è…³è¸': 'è…³è¸.html',
    'èƒŒè»Šæ®¼': 'èƒŒè»Šæ®¼.html',
    'å‰å³è¼ª': 'Pip_å‰å³è¼ª.html',
    'å‰å·¦è¼ª': 'Pip_å‰å·¦è¼ª.html',
    'å¾Œå³è¼ª': 'å¾Œå³è¼ªA.html',
    'å¾Œå·¦è¼ª': 'å¾Œå·¦è¼ªA.html'
  };

  const setSrc = (val)=>{ 
    pipFrame.src = val; 
    srcSel.value = val; 
  };
  
  srcSel.addEventListener('change', ()=> setSrc(srcSel.value));
  reloadBtn.addEventListener('click', ()=> pipFrame.src = pipFrame.src);

  document.getElementById('togglePip').addEventListener('change', e=>{
    pip.style.display = e.target.checked ? 'block' : 'none';
  });

  const opacity = document.getElementById('opacity');
  const opv = document.getElementById('opv');
  const setOpacity = v => { pip.style.opacity = (v/100).toString(); opv.textContent = v + '%'; };
  opacity.addEventListener('input', e=> setOpacity(e.target.value));
  setOpacity(opacity.value);

  const setSize = (w,h)=>{ pip.style.width = w+'px'; pip.style.height = h+'px'; };
  document.querySelectorAll('.btn[data-size]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const [w,h] = btn.dataset.size.split('x').map(Number);
      setSize(w,h);
    });
  });

  const resetPin = ()=>{ pip.style.left=''; pip.style.top=''; pip.style.right=''; pip.style.bottom=''; };
  document.getElementById('pinTL').addEventListener('click', ()=>{ resetPin(); pip.style.left='14px'; pip.style.top='14px'; });
  document.getElementById('pinTR').addEventListener('click', ()=>{ resetPin(); pip.style.right='14px'; pip.style.top='14px'; });
  document.getElementById('pinBL').addEventListener('click', ()=>{ resetPin(); pip.style.left='14px'; pip.style.bottom='74px'; });
  document.getElementById('pinBR').addEventListener('click', ()=>{ resetPin(); pip.style.right='14px'; pip.style.bottom='74px'; });

  const clickThrough = document.getElementById('clickThrough');
  clickThrough.addEventListener('change', e=>{
    pip.style.pointerEvents = e.target.checked ? 'none' : 'auto';
  });

  (function dragPip(){
    let dragging=false, sx=0, sy=0, ox=0, oy=0;
    pip.addEventListener('pointerdown', (e)=>{
      if (e.target.id === 'sizeHandle') return;
      dragging=true; sx=e.clientX; sy=e.clientY; ox=pip.offsetLeft; oy=pip.offsetTop;
      pip.setPointerCapture(e.pointerId);
    });
    pip.addEventListener('pointermove', (e)=>{
      if (!dragging) return;
      pip.style.left = (ox + e.clientX - sx)+'px';
      pip.style.top  = (oy + e.clientY - sy)+'px';
      pip.style.right=''; pip.style.bottom='';
    });
    pip.addEventListener('pointerup', ()=> dragging=false);
  })();

  (function resizePip(){
    const handle = document.getElementById('sizeHandle');
    let resizing=false, sx=0, sy=0, sw=0, sh=0;
    handle.addEventListener('pointerdown', (e)=>{
      resizing=true; sx=e.clientX; sy=e.clientY; sw=pip.offsetWidth; sh=pip.offsetHeight;
      handle.setPointerCapture(e.pointerId);
    });
    handle.addEventListener('pointermove', (e)=>{
      if (!resizing) return;
      const dw = e.clientX - sx, dh = e.clientY - sy;
      pip.style.width  = Math.max(160, sw + dw) + 'px';
      pip.style.height = Math.max(120, sh + dh) + 'px';
    });
    handle.addEventListener('pointerup', ()=> resizing=false);
  })();

  const toggleFS = document.getElementById('toggleFS');
  toggleFS.addEventListener('click', ()=>{
    pip.classList.toggle('fullscreen');
    toggleFS.textContent = pip.classList.contains('fullscreen') ? 'â›¶ é‚„åŸ' : 'â›¶ å…¨è¢å¹•';
  });

  addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k==='h') document.getElementById('togglePip').click();
    if (k==='t') document.getElementById('clickThrough').click();
    if (k==='f') toggleFS.click();
  });
  
  // é¡¯ç¤ºç‹€æ…‹æç¤º
  function showStatus(message) {
    statusIndicator.textContent = message;
    statusIndicator.classList.add('active');
    setTimeout(() => {
      statusIndicator.classList.remove('active');
    }, 2000);
  }
  
  // ğŸ”— æ–¹æ³• 1ï¼šä½¿ç”¨ localStorage é€²è¡Œè·¨ iframe é€šè¨Šï¼ˆfile:// å”è­°å¯ç”¨ï¼‰
  function switchPipByObject(objectName) {
    if (!autoSwitchCheckbox.checked) return;
    
    console.log('[Main] æ”¶åˆ°ç‰©ä»¶é¸æ“‡:', objectName);
    
    if (!objectName) {
      console.log('[Main] ç‰©ä»¶å–æ¶ˆé¸æ“‡');
      return;
    }
    
    // å°‹æ‰¾åŒ¹é…çš„æ–‡ä»¶
    let matchedFile = null;
    
    // ç²¾ç¢ºåŒ¹é…
    if (objectToFileMap[objectName]) {
      matchedFile = objectToFileMap[objectName];
    } else {
      // éƒ¨åˆ†åŒ¹é…
      for (const key in objectToFileMap) {
        if (objectName.includes(key) || key.includes(objectName)) {
          matchedFile = objectToFileMap[key];
          console.log('[Main] éƒ¨åˆ†åŒ¹é…:', key, 'â†’', matchedFile);
          break;
        }
      }
    }
    
    if (matchedFile) {
      console.log('[Main] åˆ‡æ› PiP åˆ°:', matchedFile);
      setSrc(matchedFile);
      showStatus('å·²åˆ‡æ›åˆ°: ' + objectName);
      
      // ç¢ºä¿ PiP å¯è¦‹
      const togglePipCheckbox = document.getElementById('togglePip');
      if (togglePipCheckbox && !togglePipCheckbox.checked) {
        togglePipCheckbox.checked = true;
        pip.style.display = 'block';
      }
    } else {
      console.log('[Main] âš ï¸ æœªæ‰¾åˆ°å°æ‡‰çš„æ–‡ä»¶ï¼Œç‰©ä»¶åç¨±:', objectName);
      showStatus('æ‰¾ä¸åˆ°å°æ‡‰é›¶ä»¶: ' + objectName);
    }
  }
  
  // ç›£è½ localStorage è®ŠåŒ–
  window.addEventListener('storage', (e) => {
    if (e.key === 'forklift_selected_object') {
      const objectName = e.newValue;
      if (objectName) {
        switchPipByObject(objectName);
      }
    }
  });
  
  // è¼ªè©¢æª¢æŸ¥ localStorageï¼ˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆï¼‰
  let lastSelectedObject = null;
  setInterval(() => {
    if (!autoSwitchCheckbox.checked) return;
    
    try {
      const currentObject = localStorage.getItem('forklift_selected_object');
      if (currentObject && currentObject !== lastSelectedObject) {
        lastSelectedObject = currentObject;
        switchPipByObject(currentObject);
      }
    } catch(e) {
      // localStorage å¯èƒ½è¢«ç¦ç”¨
    }
  }, 500);
  
  console.log('[Main] âœ… å·²å•Ÿç”¨ç‰©ä»¶é¸æ“‡ç›£è½ï¼ˆlocalStorage æ¨¡å¼ï¼‰');
  console.log('[Main] æ”¯æ´çš„ç‰©ä»¶:', Object.keys(objectToFileMap));
</script>

</body>
</html>
